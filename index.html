<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Horario de Relevos</title>
    <style>
        /* Estilos generales y tipografía */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f9;
            margin: 0;
            padding: 20px;
            color: #34495e;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Contenedor del encabezado principal */
        .collapsible-header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease;
        }

        .collapsible-header:hover {
            background-color: #f0f0f0;
        }

        .collapsible-header h1 {
            color: #2c3e50;
            text-align: center;
            font-size: 1.25em;
            margin: 0;
            padding: 0;
        }
        
        .collapsible-header .collapse-icon {
            font-size: 2.5em;
            color: #3498db;
            transition: transform 0.3s ease;
        }

        .collapsible-header.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        /* Contenedores y paneles de control */
        .controles-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
            max-height: 1000px;
            overflow-y: auto;
            opacity: 1;
        }

        .controles-container.content-hidden {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
            overflow-y: hidden;
        }

        /* Estilos para los paneles colapsables individuales */
        .control-panel {
            background-color: #ffffff;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 280px;
            overflow: hidden;
        }

        .control-panel .panel-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            cursor: pointer;
            border-bottom: 1px solid #ecf0f1;
            transition: background-color 0.3s ease;
        }
        
        .control-panel .panel-header:hover {
            background-color: #f0f0f0;
        }
        
        .control-panel .panel-header h3 {
            margin: 0;
            color: #34495e;
            font-size: 1.2em;
        }
        
        .control-panel .panel-header .collapse-icon {
            font-size: 1.5em;
            color: #3498db;
            transition: transform 0.3s ease;
        }

        .control-panel .panel-header.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .control-panel .panel-content {
            padding: 20px;
            text-align: center;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
            max-height: 500px;
            overflow-y: auto;
            opacity: 1;
        }
        
        .control-panel .panel-content.panel-hidden {
            max-height: 0;
            opacity: 0;
            padding: 0;
            overflow-y: hidden;
        }

        .control-panel .form-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        /* Nuevo estilo para la lista de mesas y juegos */
        .mesa-list, .juego-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .mesa-list .mesa-tag, .juego-list .juego-tag {
            background-color: #bdc3c7;
            color: white;
            padding: 5px 8px;
            border-radius: 5px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .mesa-list .mesa-tag, .juego-list-inline .juego-tag {
            background-color: #bdc3c7;
            color: white;
            padding: 5px 8px;
            border-radius: 5px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .mesa-list .mesa-tag .delete-mesa, .juego-list .juego-tag .delete-juego {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            padding: 0;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .mesa-list .mesa-tag .delete-mesa:hover, .juego-list .juego-tag .delete-juego:hover {
            color: #e74c3c;
        }

        /* Estilos de inputs y botones */
        .control-panel input[type="text"],
        .control-panel input[type="time"],
        .control-panel button,
        .control-panel select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #bdc3c7;
            box-sizing: border-box;
        }
        
        .control-panel .juegos-selector {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #bdc3c7;
            box-sizing: border-box;
            background-color: white;
            text-align: left;
            position: relative;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .control-panel .juegos-selector.active .dropdown-juegos {
            display: block;
        }
        
        .dropdown-juegos {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: white;
            border: 1px solid #bdc3c7;
            border-top: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 10;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .dropdown-juegos label {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 0;
        }
        
        .dropdown-juegos label:hover {
            background-color: #f0f0f0;
        }
        
        .dropdown-juegos input[type="checkbox"] {
            margin-right: 10px;
            width: auto;
        }

        .control-panel button {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .control-panel button:hover {
            background-color: #2980b9;
        }

        .control-panel button.danger {
            background-color: #e74c3c;
        }

        .control-panel button.danger:hover {
            background-color: #c0392b;
        }

        .control-panel button.undo-redo {
            background-color: #bdc3c7;
            color: #34495e;
        }

        .control-panel button.undo-redo:hover {
            background-color: #95a5a6;
        }
        
        .control-panel button.success {
            background-color: #2ecc71;
        }
        
        .control-panel button.success:hover {
            background-color: #27ae60;
        }

        .control-panel input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: 1px solid #bdc3c7;
            width: 40px;
            height: 40px;
            background-color: transparent;
            cursor: pointer;
            padding: 0;
        }

        /* Nuevas tablas para los elementos que se van agregando */
        .preview-table-container {
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .preview-table th, .preview-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }

        .preview-table tbody tr:hover {
            background-color: #f0f0f0;
        }
        
        .preview-table th {
            background-color: #ecf0f1;
            font-weight: bold;
        }
        
        .preview-table tr.selected {
            background-color: #d1ecf1;
        }
        
        .preview-table input[type="checkbox"] {
            margin-right: 10px;
        }

        /* Reloj digital */
        .reloj-container {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .reloj {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            background-color: #ecf0f1;
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-block;
        }

        #btn-refresh-crono {
            background-color: #1abc9c;
        }

        #btn-refresh-crono:hover {
            background-color: #16a085;
        }


        /* Contenedor principal de la tabla */
        .horario-container {
            max-width: 100%;
            margin: 0 auto;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background-color: white;
            flex-grow: 1;
        }

        /* Contenedor que permite el scroll horizontal de la tabla */
        .horario-tabla {
            overflow-x: auto;
            position: relative;
        }

        /* Estilos de la tabla - Alturas y anchos ajustados */
        .tabla {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        /* Celdas de encabezado y datos */
        .tabla th, .tabla td {
            border: 1px solid #ecf0f1;
            padding: 2px 4px;
            text-align: center;
        }

        /* Celdas de encabezado */
        .tabla thead th {
            background-color: #ecf0f1;
            font-weight: bold;
            color: #34495e;
            position: relative;
            padding: 6px;
            top: 0;
        }

        /* COLUMNAS FIJAS para el scroll horizontal */
        .tabla th:first-child, .tabla td:first-child {
            position: sticky;
            left: 0;
            z-index: 5;
            background-color: #f4f7f9;
            white-space: nowrap; /* Mantiene el texto de las celdas fijas en una línea */
        }

        .tabla thead th:first-child {
            z-index: 7;
        }

        .tabla th:nth-child(2), .tabla td:nth-child(2) {
            position: sticky;
            left: 150px;
            z-index: 5;
            background-color: #f4f7f9;
            white-space: nowrap; /* Mantiene el texto de las celdas fijas en una línea */
        }

        .tabla thead th:nth-child(2) {
            left: 150px;
            z-index: 7;
        }

        .tabla th.croupier-header {
            text-align: left;
            min-width: 150px;
            width: 150px;
        }

        .tabla th.crono-header {
            min-width: 85px;
            width: 85px;
        }
        
        .tabla thead th.agregar-horario-th {
            background-color: #3498db;
            padding: 0;
            cursor: pointer;
            transition: background-color 0.3s ease;
            position: relative;
            z-index: 1;
            width: 30px;
        }

        .tabla thead th.agregar-horario-th:hover {
            background-color: #2980b9;
        }

        .tabla thead th.agregar-horario-th span {
            color: white;
            font-size: 2em;
            line-height: 1;
            display: block;
        }

        .tabla th .horario-header-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .tabla th .edit-time {
            font-size: 0.8em;
        }

        .tabla th .delete-time {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            line-height: 1;
            padding: 0;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tabla th:hover .delete-time {
            opacity: 1;
        }

        .tabla th.editing input {
            background-color: #d1d1d1;
        }

        /* Estilos de celdas y relevos */
        .croupier-cell-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
            text-align: left;
            position: relative;
        }

        .croupier-cell-content:hover .delete-croupier {
            opacity: 1;
        }

        .delete-croupier {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            line-height: 1;
            padding: 0;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 6;
        }

        .croupier-cell-content .name-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .croupier-cell-content .croupier-name {
            font-weight: bold;
        }

        .croupier-cell-content .salida-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Estilos para la tarjeta de Salida */
        .salida-card {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.8em;
            font-weight: bold;
        }

        .salida-card:hover {
            background-color: #e0e0e0;
        }

        .salida-card.warning {
            background-color: #e74c3c;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .salida-card .icon-salida {
            font-size: 1.2em;
        }

        .salida-card.warning .icon-salida {
            color: #f1c40f;
        }

        .salida-card .salida-time {
            font-size: 1.1em;
        }

        .salida-card .warning-icon {
            color: #f1c40f;
            animation: none;
            font-size: 1.2em;
            margin-left: 5px;
        }

        .salida-card.warning .warning-icon {
            animation: pulse-warning 1s infinite;
        }

        @keyframes pulse-warning {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }


        /* Celdas del nombre del croupier */
        .croupier-row td:first-child {
            cursor: default;
        }
        
        .relevo-cell {
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 0.7em; /* Ancho ajustado para que el texto ocupe menos espacio */
            font-weight: bold;
            color: white;
            line-height: 1.2;
            display: block; /* La tarjeta ocupa todo el ancho de la celda */
        }
        
        .relevo-cell.ayudante-pagador {
            background-color: #8e44ad;
        }

        .croupier-row {
            transition: background-color 0.3s ease;
        }

        /* Estilos para arrastrar y soltar */
        .croupier-row.sortable-chosen {
            background-color: #e0e0e0;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            transform: scale(1.02);
            cursor: grabbing;
        }

        .croupier-row.sortable-ghost {
            opacity: 0.5;
            background-color: #c8ebfb;
        }

        /* Cronómetro */
        .cronometro-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            min-width: 50px;
        }

        .cronometro-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2px;
            background-color: #f0f0f0;
            border-radius: 5px;
            border: 1px solid #bdc3c7;
            transition: background-color 0.3s ease;
            font-weight: bold;
        }

        .cronometro-display:hover {
            background-color: #e8e8e8;
        }

        .cronometro-display.running {
            background-color: #2ecc71;
            color: white;
            border-color: #27ae60;
        }

        .cronometro-display.warning {
            background-color: #e74c3c;
            color: white;
            border-color: #c0392b;
        }

        .cronometro-display .timer {
            font-size: 0.8em;
        }

        /* Modal general */
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #34495e;
        }

        .modal-body select, .modal-body input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        .modal-body h4 {
            margin: 10px 0;
        }

        .modal-body label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .modal-body .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 10px;
            margin-top: 10px;
        }

        .modal-body .checkbox-container label {
            margin-bottom: 0;
        }

        .modal-footer {
            margin-top: 20px;
            text-align: right;
            border-top: 1px solid #ecf0f1;
            padding-top: 15px;
        }

        .modal-footer button {
            width: auto;
            margin-left: 10px;
        }

        /* Estilos del nuevo selector de mesas con drag-and-drop */
        #mesas-selector {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 15px;
        }

        #mesas-selector > div {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            background-color: #f9f9f9;
        }

        #mesas-selector h5 {
            margin: 0 0 10px 0;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        #mesas-disponibles, #mesas-seleccionadas {
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            background-color: #fff;
            padding: 5px;
        }

        #mesas-selector .mesa-item {
            padding: 8px;
            margin: 5px;
            background-color: #ecf0f1;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
        }

        #mesas-selector .mesa-item:hover {
            background-color: #bdc3c7;
        }

        #mesas-seleccionadas .mesa-item {
            background-color: #3498db;
            color: white;
            cursor: move;
        }

        #mesas-seleccionadas .sortable-ghost {
            opacity: 0.4;
            background-color: #c8ebfb;
        }

        #mesas-seleccionadas .sortable-chosen {
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transform: scale(1.05);
        }

        /* Modal de Salida */
        #salida-modal-content {
            text-align: center;
        }

        #salida-modal-content .salida-time-display {
            font-size: 3em;
            font-weight: bold;
            color: #34495e;
            margin: 20px 0;
        }

        #salida-modal-content input[type="time"] {
            font-size: 1.5em;
            width: 100%;
        }

        /* Estilos para los radio buttons del modal de relevo */
        #relevo-modal-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        #relevo-modal-options div {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .juego-tag {
            background-color: #2ecc71;
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            margin-right: 5px;
        }

        /* Estilos del panel de croupiers */
        #croupier-details-container {
            text-align: left;
            margin-top: 15px;
            border-top: 1px solid #ecf0f1;
            padding-top: 15px;
        }

        #croupier-details-container h4 {
            margin-bottom: 5px;
        }
        
        #croupier-details-container .editable-field {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        #croupier-details-container .editable-field p {
            margin: 0;
            font-weight: bold;
        }

        #croupier-name-edit-container {
            flex-grow: 1;
        }
        
        #croupier-details-name-edit {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
        }

        #croupier-details-name-display {
            font-weight: bold;
        }

        #croupier-details-container .juego-list-inline {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        #edit-croupier-juegos-selector {
            display: none;
            margin-bottom: 10px;
        }
        
        #edit-croupier-juegos-selector.active {
            display: block;
        }
        
        #edit-croupier-buttons {
            display: flex; /* CAMBIO: Ahora se muestra por defecto */
            gap: 10px;
            margin-top: 10px;
        }
        
        #btn-editar-croupier, #btn-guardar-edicion, #btn-cancelar-edicion, #btn-eliminar-croupier-pre {
            width: auto;
            flex: 1;
        }
        
        /* CAMBIO: Se ocultan los botones de guardar/cancelar por defecto */
        #btn-guardar-edicion, #btn-cancelar-edicion {
            display: none;
        }

        /* MEDIA QUERY PARA MÓVILES - AJUSTE DE LA TABLA Y EL MODAL */
        @media (max-width: 600px) {
            .horario-tabla {
                overflow-x: auto;
            }

            .tabla {
                min-width: auto;
                width: 100%;
            }

            .tabla th.croupier-header,
            .tabla td:first-child {
                min-width: auto;
                width: auto;
                padding: 5px;
            }

            .croupier-cell-content {
                gap: 5px;
            }

            .croupier-cell-content .croupier-name {
                font-size: 0.9em;
            }

            .croupier-cell-content .croupier-name input {
                width: 80px;
            }

            .salida-card {
                font-size: 0.7em;
                padding: 2px 5px;
            }

            .cronometro-cell {
                min-width: 60px;
            }

            .cronometro-display .timer {
                font-size: 0.7em;
            }

            /* Ajustes del modal para móviles */
            .modal-content {
                width: 95%;
                padding: 15px;
            }

            #mesas-selector {
                flex-direction: column;
                gap: 10px;
            }

            #mesas-selector > div {
                flex: none;
                width: 100%;
            }

            #mesas-selector h5 {
                font-size: 1em;
            }

            #mesas-disponibles, #mesas-seleccionadas {
                max-height: 150px;
            }

            .modal-body p {
                font-size: 0.9em;
            }

            .modal-body h4 {
                font-size: 1.1em;
            }

            #salida-modal-content input[type="time"] {
                font-size: 1.2em;
            }
        }
        
        /* Estilos del pie de página */
        footer {
            margin-top: 20px;
            padding: 15px 0;
            text-align: center;
            font-size: 0.8em;
            color: #95a5a6;
            border-top: 1px solid #ecf0f1;
        }
    </style>
</head>
<body>

    <div class="collapsible-header collapsed" id="collapsible-header">
        <h1>Sistema de Horario de Relevos</h1>
        <span class="collapse-icon">▼</span>
    </div>

    <div class="controles-container content-hidden" id="controles-container">

        <div class="control-panel">
            <div class="panel-header" id="header-gestion-datos">
                <h3>Gestión de Datos</h3>
                <span class="collapse-icon">▼</span>
            </div>
            <div class="panel-content panel-hidden">
                <h4>Historial</h4>
                <div class="form-group">
                    <button id="btn-undo" class="undo-redo">Deshacer</button>
                    <button id="btn-redo" class="undo-redo">Rehacer</button>
                </div>
                
                <hr style="margin: 15px 0;">

                <h4>Opciones de Borrado</h4>
                <button id="btn-clear-horario-only" class="danger" style="margin-bottom: 10px;">Borrar SOLO tabla de Horarios</button>
                <button id="btn-clear-all" class="danger">Borrar TODO el Sistema</button>
                
                <hr style="margin: 15px 0;">
                
                <h4>Backup y Restaurar</h4>
                <div class="form-group">
                    <button id="btn-backup" class="success">Hacer Backup</button>
                    <label for="file-input-restore" class="button">Restaurar</label>
                    <input type="file" id="file-input-restore" accept=".json" style="display: none;">
                </div>
            </div>
        </div>

        <div class="control-panel">
            <div class="panel-header" id="header-croupiers">
                <h3>Croupiers y Juegos</h3>
                <span class="collapse-icon">▼</span>
            </div>
            <div class="panel-content panel-hidden">
                <h4>Base de datos de croupiers</h4>
                <div class="form-group">
                    <input type="text" id="nuevo-croupier-input" placeholder="Nombre y Apellido">
                </div>
                <div class="form-group">
                    <input type="text" id="nuevo-juego-input" placeholder="Agregar nuevo juego">
                    <button id="btn-pre-agregar-juego" style="width: auto;">+</button>
                </div>
                <div class="juegos-selector" id="juegos-selector-croupier">
                    Seleccionar juegos
                    <div class="dropdown-juegos" id="dropdown-juegos"></div>
                </div>
                <button id="btn-agregar-croupier-db">Agregar a la Base de Datos</button>
                
                <hr style="margin: 15px 0;">
                
                <h4>Croupiers registrados</h4>
                <div class="preview-table-container">
                    <table class="preview-table" id="croupier-pre-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-pre-croupiers"></th>
                                <th>Nombre</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="croupier-details-container">
                    <h4>Detalles del Croupier</h4>
                    <div class="editable-field">
                        <p><strong>Nombre:</strong></p>
                        <div id="croupier-name-edit-container">
                            <span id="croupier-details-name-display"></span>
                            <input type="text" id="croupier-details-name-edit" style="display: none;">
                        </div>
                    </div>

                    <div id="croupier-juegos-display">
                        <p><strong>Juegos que paga:</strong></p>
                        <div id="croupier-details-juegos" class="juego-list-inline"></div>
                    </div>

                    <div id="edit-croupier-juegos-selector">
                        <p><strong>Editar juegos:</strong></p>
                        <div class="juegos-selector" id="juegos-selector-edit">
                            Seleccionar juegos
                            <div class="dropdown-juegos" id="dropdown-juegos-edit"></div>
                        </div>
                    </div>
                    
                    <div id="edit-croupier-buttons" class="form-group">
                        <button id="btn-editar-croupier">Editar</button>
                        <button id="btn-guardar-edicion">Guardar</button>
                        <button id="btn-cancelar-edicion" class="undo-redo">Cancelar</button>
                    </div>

                    <div class="form-group">
                        <button id="btn-eliminar-croupier-pre" class="danger">Eliminar de la Base de Datos</button>
                    </div>

                    <hr style="margin: 15px 0;">
                </div>

                <div class="form-group" style="margin-top: 10px;">
                    <button id="btn-agregar-croupier-tabla">Agregar seleccionados al Horario</button>
                </div>
                <div class="form-group">
                    <input type="color" id="color-picker" value="#3498db">
                    <button id="btn-aplicar-color">Aplicar Color</button>
                </div>
            </div>
        </div>

        <div class="control-panel">
            <div class="panel-header" id="header-mesas">
                <h3>Mesas de juego</h3>
                <span class="collapse-icon">▼</span>
            </div>
            <div class="panel-content panel-hidden">
                <div class="form-group">
                    <input type="text" id="nueva-mesa-input" placeholder="ID de Mesa">
                </div>
                <button id="btn-agregar-mesa">Agregar Mesa</button>
                <div id="mesas-list" class="mesa-list"></div>
            </div>
        </div>

    </div>

    <div class="reloj-container">
        <div id="reloj-digital" class="reloj"></div>
        <button id="btn-refresh-crono" class="control-panel">Refrescar Cronómetros</button>
    </div>

    <div class="horario-container">
        <div class="horario-tabla">
            <table class="tabla" id="tabla-horario">
                <thead>
                    <tr></tr>
                </thead>
                <tbody id="sortable-tbody"></tbody>
            </table>
        </div>
    </div>

    <div id="relevo-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="modal-title">Asignar actividad</h2>
            <div class="modal-body">
                <p>Croupier: <strong id="croupier-info"></strong><br>Horario: <strong id="horario-info"></strong></p>

                <hr style="margin: 20px 0;">

                <h4>Selecciona la actividad:</h4>
                <div id="relevo-modal-options">
                    <div>
                        <input type="radio" id="opcion-relevo" name="actividad" value="releva" checked>
                        <label for="opcion-relevo">Relevo (Trabajo)</label>
                    </div>
                    <div>
                        <input type="radio" id="opcion-ayudante" name="actividad" value="ayudante-pagador">
                        <label for="opcion-ayudante">Ayudante Pagador</label>
                    </div>
                    <div>
                        <input type="radio" id="opcion-descanso" name="actividad" value="descanso">
                        <label for="opcion-descanso">Descanso</label>
                    </div>
                </div>

                <div id="relevo-controls-container">
                    <h4>Asignar mesas:</h4>
                    <div id="mesas-selector">
                        <div>
                            <h5>Mesas disponibles</h5>
                            <div id="mesas-disponibles"></div>
                        </div>
                        <div>
                            <h5>Mesas seleccionadas</h5>
                            <div id="mesas-seleccionadas"></div>
                        </div>
                    </div>

                    <div id="color-container">
                        <label for="color-relevo">Color de la tarjeta:</label>
                        <input type="color" id="color-relevo" value="#3498db">
                    </div>

                    <div class="checkbox-container">
                        <input type="checkbox" id="aplicar-descanso-auto" checked>
                        <label for="aplicar-descanso-auto">Asignar descanso automático al croupier relevado</label>
                    </div>
                </div>

                <hr style="margin: 20px 0;">

                <h4>Asignar descanso manual</h4>
                <div id="croupier-container-descanso">
                    <label for="select-croupier-descanso">Seleccionar croupier para descanso:</label>
                    <select id="select-croupier-descanso" multiple>
                        <option value="">(Ninguno)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btn-guardar-relevo" class="confirm">Guardar</button>
                <button id="btn-borrar-relevo" class="danger">Borrar</button>
            </div>
        </div>
    </div>

    <div id="agregar-horario-modal" class="modal">
        <div class="modal-content small">
            <span class="close-btn">&times;</span>
            <h2>Agregar Nuevo Horario</h2>
            <div class="modal-body">
                <label for="input-nuevo-horario">Hora:</label>
                <input type="time" id="input-nuevo-horario" style="margin-top: 5px;">
            </div>
            <div class="modal-footer">
                <button id="btn-guardar-nuevo-horario" class="confirm">Agregar Hora</button>
            </div>
        </div>
    </div>

    <div id="salida-modal" class="modal">
        <div class="modal-content small" id="salida-modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="salida-modal-title">Hora de salida para <span></span></h2>
            <div class="salida-time-display">
                <span id="salida-time-display">--:--</span>
            </div>
            <div class="modal-body">
                <input type="time" id="input-salida-time">
            </div>
            <div class="modal-footer">
                <button id="btn-borrar-salida" class="danger">Borrar Hora</button>
                <button id="btn-guardar-salida" class="confirm">Guardar</button>
            </div>
        </div>
    </div>

    <div id="crono-modal" class="modal">
        <div class="modal-content" id="crono-modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="crono-modal-title">Cronómetro para <span></span></h2>
            <div class="timer-container">
                <span id="crono-modal-timer">00:00:00</span>
            </div>
            <div class="modal-buttons">
                <button id="crono-btn-start" class="start">Iniciar</button>
                <button id="crono-btn-stop" class="danger">Detener</button>
                <button id="crono-btn-reset" class="undo-redo">Reiniciar a 0</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        // --- DATOS DEL SISTEMA ---
        let croupiersData = [];
        let horarios = [];
        let mesasDeJuego = [];
        let juegosMaestro = ["Poker", "Blackjack", "Ruleta", "Craps", "Mini&PuntoyBanca", "Bug-six", "Caribbean", "Draw", "Hold'em"];
        let datosRelevos = {};
        let croupierColors = {};
        let croupierSalidas = {};
        let horarioColors = {};
        
        let croupiersEnEspera = [];

        // --- GESTIÓN DEL CRONÓMETRO ---
        let cronometroIntervals = {};
        let cronometroStartTime = {};

        // --- HISTORIAL DE ESTADOS ---
        let historial = [];
        let historialIndex = -1;
        const MAX_HISTORIAL = 20;

        // --- DATA TEMPORAL PARA MODALES ---
        let celdaActiva = { croupier: null, horario: null };
        let croupierCronoActivo = null;
        let croupierSalidaActivo = null;
        
        let croupierSeleccionadoPre = null;
        let isEditingPreCroupier = false;


        // --- REFERENCIAS A ELEMENTOS DEL DOM ---
        const tablaHorario = document.getElementById('tabla-horario');
        const thead = tablaHorario.querySelector('thead tr');
        const tbody = document.getElementById('sortable-tbody');

        const nuevoCroupierInput = document.getElementById('nuevo-croupier-input');
        const nuevoJuegoInput = document.getElementById('nuevo-juego-input');
        const juegosSelectorCroupier = document.getElementById('juegos-selector-croupier');
        const dropdownJuegos = document.getElementById('dropdown-juegos');
        const btnAgregarCroupierDB = document.getElementById('btn-agregar-croupier-db');
        const btnPreAgregarJuego = document.getElementById('btn-pre-agregar-juego');
        const btnAgregarCroupierTabla = document.getElementById('btn-agregar-croupier-tabla');
        const croupierPreTableBody = document.getElementById('croupier-pre-table').querySelector('tbody');
        const selectAllPreCroupiers = document.getElementById('select-all-pre-croupiers');

        // NUEVOS ELEMENTOS PARA DETALLES DEL CROUPIER
        const croupierDetailsContainer = document.getElementById('croupier-details-container');
        const croupierDetailsNameDisplay = document.getElementById('croupier-details-name-display');
        const croupierDetailsNameEdit = document.getElementById('croupier-details-name-edit');
        const croupierJuegosDisplay = document.getElementById('croupier-juegos-display');
        const croupierDetailsJuegos = document.getElementById('croupier-details-juegos');
        const editCroupierJuegosSelector = document.getElementById('edit-croupier-juegos-selector');
        const dropdownJuegosEdit = document.getElementById('dropdown-juegos-edit');
        const btnEditarCroupier = document.getElementById('btn-editar-croupier');
        const btnGuardarEdicion = document.getElementById('btn-guardar-edicion');
        const btnCancelarEdicion = document.getElementById('btn-cancelar-edicion');
        const btnEliminarCroupierPre = document.getElementById('btn-eliminar-croupier-pre');

        const nuevaMesaInput = document.getElementById('nueva-mesa-input');
        const btnAgregarMesa = document.getElementById('btn-agregar-mesa');

        const mesasListDiv = document.getElementById('mesas-list');
        const colorPicker = document.getElementById('color-picker');
        const btnAplicarColor = document.getElementById('btn-aplicar-color');
        const relojDigital = document.getElementById('reloj-digital');
        const btnRefreshCrono = document.getElementById('btn-refresh-crono');

        const relevoModal = document.getElementById('relevo-modal');
        const closeBtnRelevo = relevoModal.querySelector('.close-btn');
        const modalTitle = document.getElementById('modal-title');
        const mesasDisponiblesDiv = document.getElementById('mesas-disponibles');
        const mesasSeleccionadasDiv = document.getElementById('mesas-seleccionadas');
        const croupierContainerDescanso = document.getElementById('croupier-container-descanso');
        const selectCroupierDescanso = document.getElementById('select-croupier-descanso');
        const colorContainer = document.getElementById('color-container');
        const colorRelevoInput = document.getElementById('color-relevo');
        const btnGuardarRelevo = document.getElementById('btn-guardar-relevo');
        const btnBorrarRelevo = document.getElementById('btn-borrar-relevo');
        const croupierInfo = document.getElementById('croupier-info');
        const horarioInfo = document.getElementById('horario-info');
        const aplicarDescansoAutoCheckbox = document.getElementById('aplicar-descanso-auto');
        const relevoControlsContainer = document.getElementById('relevo-controls-container');
        const radioReleva = document.getElementById('opcion-relevo');
        const radioAyudante = document.getElementById('opcion-ayudante');
        const radioDescanso = document.getElementById('opcion-descanso');

        const agregarHorarioModal = document.getElementById('agregar-horario-modal');
        const inputNuevoHorario = document.getElementById('input-nuevo-horario');
        const btnGuardarNuevoHorario = document.getElementById('btn-guardar-nuevo-horario');
        const closeBtnAgregarHorario = agregarHorarioModal.querySelector('.close-btn');

        const salidaModal = document.getElementById('salida-modal');
        const closeBtnSalida = salidaModal.querySelector('.close-btn');
        const salidaModalTitle = document.getElementById('salida-modal-title');
        const salidaTimeDisplay = document.getElementById('salida-time-display');
        const inputSalidaTime = document.getElementById('input-salida-time');
        const btnGuardarSalida = document.getElementById('btn-guardar-salida');
        const btnBorrarSalida = document.getElementById('btn-borrar-salida');

        const btnClearAll = document.getElementById('btn-clear-all');
        const btnClearHorarioOnly = document.getElementById('btn-clear-horario-only');
        const btnBackup = document.getElementById('btn-backup');
        const fileInputRestore = document.getElementById('file-input-restore');

        const btnUndo = document.getElementById('btn-undo');
        const btnRedo = document.getElementById('btn-redo');

        const cronoModal = document.getElementById('crono-modal');
        const closeBtnCrono = cronoModal.querySelector('.close-btn');
        const cronoModalTitle = document.getElementById('crono-modal-title');
        const cronoModalTimer = document.getElementById('crono-modal-timer');
        const cronoBtnStart = document.getElementById('crono-btn-start');
        const cronoBtnStop = document.getElementById('crono-btn-stop');
        const cronoBtnReset = document.getElementById('crono-btn-reset');

        const collapsibleHeader = document.getElementById('collapsible-header');
        const controlesContainer = document.getElementById('controles-container');
        
        // --- FUNCIÓN DE GESTIÓN DE DATOS ---
        function guardarDatos() {
            localStorage.setItem('croupiersData', JSON.stringify(croupiersData));
            localStorage.setItem('horarios', JSON.stringify(horarios));
            localStorage.setItem('mesasDeJuego', JSON.stringify(mesasDeJuego));
            localStorage.setItem('juegosMaestro', JSON.stringify(juegosMaestro));
            localStorage.setItem('datosRelevos', JSON.stringify(datosRelevos));
            localStorage.setItem('croupierColors', JSON.stringify(croupierColors));
            localStorage.setItem('croupierSalidas', JSON.stringify(croupierSalidas));
            localStorage.setItem('horarioColors', JSON.stringify(horarioColors));
            localStorage.setItem('cronometroState', JSON.stringify(cronometroStartTime));
            localStorage.setItem('croupiersEnEspera', JSON.stringify(croupiersEnEspera));
        }

        function cargarDatos() {
            const savedCroupiersData = localStorage.getItem('croupiersData');
            const savedMesas = localStorage.getItem('mesasDeJuego');
            const savedJuegos = localStorage.getItem('juegosMaestro');
            const savedHorarios = localStorage.getItem('horarios');
            const savedDatos = localStorage.getItem('datosRelevos');
            const savedColors = localStorage.getItem('croupierColors');
            const savedSalidas = localStorage.getItem('croupierSalidas');
            const savedHorarioColors = localStorage.getItem('horarioColors');
            const savedCroupiersEnEspera = localStorage.getItem('croupiersEnEspera');

            if (savedCroupiersData) croupiersData = JSON.parse(savedCroupiersData);
            if (savedMesas) mesasDeJuego = JSON.parse(savedMesas);
            if (savedJuegos) juegosMaestro = JSON.parse(savedJuegos);
            if (savedHorarios) horarios = JSON.parse(savedHorarios);
            if (savedDatos) datosRelevos = JSON.parse(savedDatos);
            if (savedColors) croupierColors = JSON.parse(savedColors);
            if (savedSalidas) croupierSalidas = JSON.parse(savedSalidas);
            if (savedHorarioColors) horarioColors = JSON.parse(savedHorarioColors);
            if (savedCroupiersEnEspera) croupiersEnEspera = JSON.parse(savedCroupiersEnEspera);
        }

        function cargarCronometroState() {
            const savedCronoState = localStorage.getItem('cronometroState');
            if (savedCronoState) {
                cronometroStartTime = JSON.parse(savedCronoState);
            }
        }
        
        function generarBackup() {
            const backupData = {
                croupiersData,
                horarios,
                mesasDeJuego,
                juegosMaestro,
                datosRelevos,
                croupierColors,
                croupierSalidas,
                horarioColors,
                cronometroStartTime,
                croupiersEnEspera
            };
            const jsonString = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const now = new Date();
            const filename = `backup-horario-${now.toISOString().slice(0, 10)}.json`;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Backup guardado correctamente.');
        }
        
        function restaurarBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (confirm('¿Estás seguro de que quieres restaurar la información? Se sobrescribirán todos los datos actuales del sistema.')) {
                        croupiersData = backupData.croupiersData || [];
                        horarios = backupData.horarios || [];
                        mesasDeJuego = backupData.mesasDeJuego || [];
                        juegosMaestro = backupData.juegosMaestro || [];
                        datosRelevos = backupData.datosRelevos || {};
                        croupierColors = backupData.croupierColors || {};
                        croupierSalidas = backupData.croupierSalidas || {};
                        horarioColors = backupData.horarioColors || {};
                        cronometroStartTime = backupData.cronometroStartTime || {};
                        croupiersEnEspera = backupData.croupiersEnEspera || [];
                        
                        stopAllTimers(false); // Detiene los cronómetros pero no borra el estado
                        localStorage.clear();
                        guardarDatos(); // Guarda los nuevos datos restaurados
                        renderizarHorario();
                        startSavedTimers(); // Inicia los cronómetros desde el backup
                        alert('Datos restaurados correctamente.');
                    }
                } catch (error) {
                    alert('Error al leer el archivo. Asegúrate de que sea un archivo de backup válido.');
                    console.error('Error al restaurar el backup:', error);
                }
            };
            reader.readAsText(file);
        }

        function guardarEstado() {
            if (historialIndex < historial.length - 1) {
                historial = historial.slice(0, historialIndex + 1);
            }

            const estado = {
                croupiersData: JSON.parse(JSON.stringify(croupiersData)),
                horarios: [...horarios],
                mesasDeJuego: [...mesasDeJuego],
                juegosMaestro: [...juegosMaestro],
                datosRelevos: JSON.parse(JSON.stringify(datosRelevos)),
                croupierColors: JSON.parse(JSON.stringify(croupierColors)),
                croupierSalidas: JSON.parse(JSON.stringify(croupierSalidas)),
                horarioColors: JSON.parse(JSON.stringify(horarioColors)),
                croupiersEnEspera: JSON.parse(JSON.stringify(croupiersEnEspera))
            };
            historial.push(estado);
            historialIndex++;

            if (historial.length > MAX_HISTORIAL) {
                historial.shift();
                historialIndex--;
            }

            actualizarBotonesDeshacerRehacer();
        }

        function cargarEstado(estado) {
            croupiersData = JSON.parse(JSON.stringify(estado.croupiersData));
            horarios = [...estado.horarios];
            mesasDeJuego = [...estado.mesasDeJuego];
            juegosMaestro = [...estado.juegosMaestro];
            datosRelevos = JSON.parse(JSON.stringify(estado.datosRelevos));
            croupierColors = JSON.parse(JSON.stringify(estado.croupierColors));
            croupierSalidas = JSON.parse(JSON.stringify(estado.croupierSalidas));
            horarioColors = JSON.parse(JSON.stringify(estado.horarioColors));
            croupiersEnEspera = JSON.parse(JSON.stringify(estado.croupiersEnEspera));
            renderizarHorario(false);
            renderizarJuegosDropdown();
            renderizarCroupiersPreTable();
        }

        function deshacer() {
            if (historialIndex > 0) {
                historialIndex--;
                cargarEstado(historial[historialIndex]);
            }
        }

        function rehacer() {
            if (historialIndex < historial.length - 1) {
                historialIndex++;
                cargarEstado(historial[historialIndex]);
            }
        }

        function actualizarBotonesDeshacerRehacer() {
            btnUndo.disabled = historialIndex <= 0;
            btnRedo.disabled = historialIndex >= historial.length - 1;
        }

        function renderizarHorario(shouldSaveState = true, scrollToTime = null) {
            renderizarCabecera();
            renderizarCuerpo();
            renderizarMesasList();
            renderizarJuegosDropdown();
            renderizarCroupiersPreTable();
            guardarDatos();
            if (shouldSaveState) {
                guardarEstado();
            }
            if (scrollToTime) {
                scrollToColumn(scrollToTime);
            }
        }

        function stopAllTimers(resetState = true) {
            for (const croupier in cronometroIntervals) {
                clearInterval(cronometroIntervals[croupier]);
                const displayCard = document.querySelector(`[data-croupier-crono="${croupier}"] .cronometro-display`);
                if (displayCard) displayCard.classList.remove('running', 'warning');
                if (resetState) {
                    delete cronometroStartTime[croupier];
                }
            }
            cronometroIntervals = {};
            if(resetState) {
                 localStorage.removeItem('cronometroState');
            }
        }

        function startSavedTimers() {
            for(const croupier in cronometroStartTime) {
                startCronometro(croupier, cronometroStartTime[croupier]);
            }
        }

        function renderizarCabecera() {
            thead.innerHTML = '';

            const thCroupier = document.createElement('th');
            thCroupier.className = 'croupier-header';
            const selectAll = document.createElement('input');
            selectAll.type = 'checkbox';
            selectAll.id = 'select-all-croupiers';
            selectAll.addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('.croupier-checkbox');
                checkboxes.forEach(cb => cb.checked = e.target.checked);
            });
            thCroupier.appendChild(selectAll);
            thCroupier.innerHTML += ' Nombre y Salida';
            thead.appendChild(thCroupier);

            const thCrono = document.createElement('th');
            thCrono.className = 'crono-header';
            thCrono.textContent = 'Crono.';
            thead.appendChild(thCrono);

            horarios.forEach(hora => {
                const th = document.createElement('th');
                th.dataset.horario = hora;
                const contentDiv = document.createElement('div');
                contentDiv.className = 'horario-header-content';

                const editSpan = document.createElement('span');
                editSpan.className = 'edit-time';
                editSpan.textContent = hora;
                editSpan.addEventListener('click', () => editarHorario(hora));

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-time';
                deleteBtn.textContent = 'x';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    borrarHorario(hora);
                });

                contentDiv.appendChild(editSpan);
                contentDiv.appendChild(deleteBtn);

                if (horarioColors[hora]) {
                    th.style.backgroundColor = horarioColors[hora];
                }

                th.appendChild(contentDiv);
                thead.appendChild(th);
            });

            const thAgregar = document.createElement('th');
            thAgregar.className = 'agregar-horario-th';
            thAgregar.innerHTML = '<span>+</span>';
            thAgregar.addEventListener('click', abrirAgregarHorarioModal);
            thead.appendChild(thAgregar);
        }

        function renderizarCuerpo() {
            tbody.innerHTML = '';
            croupiersData.forEach(croupierObj => {
                const croupierNombre = croupierObj.nombreCompleto;
                const tr = document.createElement('tr');
                tr.classList.add('croupier-row');
                tr.dataset.croupier = croupierNombre;

                const tdNombre = document.createElement('td');
                const croupierColor = croupierColors[croupierNombre];
                if (croupierColor) {
                    tdNombre.style.backgroundColor = croupierColor;
                }

                const contentDiv = document.createElement('div');
                contentDiv.className = 'croupier-cell-content';

                const nameRow = document.createElement('div');
                nameRow.className = 'name-row';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'croupier-checkbox';
                checkbox.value = croupierNombre;
                nameRow.appendChild(checkbox);

                const nameSpan = document.createElement('span');
                nameSpan.className = 'croupier-name';
                nameSpan.textContent = croupierObj.alias;
                nameRow.appendChild(nameSpan);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-croupier';
                deleteBtn.textContent = 'x';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    borrarCroupier(croupierNombre);
                });
                contentDiv.appendChild(deleteBtn);

                contentDiv.appendChild(nameRow);

                const salidaCard = document.createElement('div');
                salidaCard.className = 'salida-card';
                salidaCard.dataset.croupierSalida = croupierNombre;
                salidaCard.innerHTML = `
                    <span class="icon-salida">⏰</span>
                    <span class="salida-time">${croupierSalidas[croupierNombre] || '--:--'}</span>
                `;
                salidaCard.addEventListener('click', () => abrirSalidaModal(croupierNombre));
                contentDiv.appendChild(salidaCard);

                tdNombre.appendChild(contentDiv);
                tr.appendChild(tdNombre);

                tdNombre.addEventListener('click', (e) => {
                    if (e.target.type === 'checkbox' || e.target.tagName === 'INPUT' || e.target.classList.contains('delete-croupier') || e.target.closest('.salida-card')) {
                        return;
                    }
                    checkbox.checked = !checkbox.checked;
                });

                const tdCrono = document.createElement('td');
                tdCrono.className = 'cronometro-cell';
                tdCrono.dataset.croupierCrono = croupierNombre;

                const cronoDisplay = document.createElement('div');
                cronoDisplay.className = 'cronometro-display';
                cronoDisplay.innerHTML = `<span class="timer">00:00:00</span>`;
                cronoDisplay.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openCronoModal(croupierNombre);
                });
                tdCrono.appendChild(cronoDisplay);

                tr.appendChild(tdCrono);

                horarios.forEach(hora => {
                    const td = document.createElement('td');
                    td.dataset.croupier = croupierNombre;
                    td.dataset.horario = hora;

                    if (horarioColors[hora]) {
                        td.style.backgroundColor = horarioColors[hora];
                    }

                    td.addEventListener('click', () => abrirRelevoModal(croupierNombre, hora));

                    const relevoData = datosRelevos[croupierNombre] ? datosRelevos[croupierNombre][hora] : null;
                    if (relevoData) {
                        const relevoDiv = crearTarjetaRelevo(relevoData);
                        td.appendChild(relevoDiv);
                    }
                    tr.appendChild(td);
                });

                tr.appendChild(document.createElement('td'));

                tbody.appendChild(tr);
            });
        }
        
        function scrollToColumn(time) {
            const tableContainer = document.querySelector('.horario-tabla');
            const columnHeader = document.querySelector(`th[data-horario="${time}"]`);
            if (columnHeader && tableContainer) {
                const fixedColumnsWidth = document.querySelector('.tabla th:first-child').offsetWidth + document.querySelector('.tabla th:nth-child(2)').offsetWidth;
                tableContainer.scroll({
                    left: columnHeader.offsetLeft - fixedColumnsWidth,
                    behavior: 'smooth'
                });
            }
        }

        function renderizarCroupiersPreTable() {
            croupierPreTableBody.innerHTML = '';
            croupiersEnEspera.forEach(croupier => {
                const tr = document.createElement('tr');
                tr.dataset.nombreCompleto = croupier.nombreCompleto;
                tr.addEventListener('click', () => {
                    seleccionarCroupierPre(croupier.nombreCompleto);
                });

                const tdCheckbox = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'pre-croupier-checkbox';
                checkbox.value = croupier.nombreCompleto;
                checkbox.addEventListener('change', (e) => e.stopPropagation());
                tdCheckbox.appendChild(checkbox);
                tr.appendChild(tdCheckbox);

                const tdNombre = document.createElement('td');
                tdNombre.textContent = croupier.nombreCompleto;
                tr.appendChild(tdNombre);

                croupierPreTableBody.appendChild(tr);
            });

            btnAgregarCroupierTabla.disabled = croupiersEnEspera.length === 0;
            selectAllPreCroupiers.disabled = croupiersEnEspera.length === 0;

            if (croupiersEnEspera.length > 0) {
                seleccionarCroupierPre(croupiersEnEspera[0].nombreCompleto);
            } else {
                croupierDetailsContainer.style.display = 'none';
            }
        }
        
        function seleccionarCroupierPre(nombreCompleto) {
            const filas = document.querySelectorAll('#croupier-pre-table tbody tr');
            const clickedRow = document.querySelector(`[data-nombre-completo="${nombreCompleto}"]`);
            
            filas.forEach(fila => fila.classList.remove('selected'));
            
            if (clickedRow) {
                clickedRow.classList.add('selected');
                const croupier = croupiersEnEspera.find(c => c.nombreCompleto === nombreCompleto);
                if (croupier) {
                    croupierSeleccionadoPre = nombreCompleto;
                    croupierDetailsNameDisplay.textContent = croupier.nombreCompleto;
                    croupierDetailsNameEdit.value = croupier.nombreCompleto;

                    croupierDetailsJuegos.innerHTML = '';
                    croupier.juegosQuePaga.forEach(juego => {
                        const juegoTag = document.createElement('div');
                        juegoTag.className = 'juego-tag';
                        juegoTag.textContent = juego;
                        croupierDetailsJuegos.appendChild(juegoTag);
                    });
                    if (croupier.juegosQuePaga.length === 0) {
                        const noJuegosText = document.createElement('span');
                        noJuegosText.textContent = 'No se han asignado juegos.';
                        croupierDetailsJuegos.appendChild(noJuegosText);
                    }
                    
                    croupierDetailsContainer.style.display = 'block';
                    toggleEditModePreCroupier(false);
                }
            } else {
                croupierSeleccionadoPre = null;
                croupierDetailsContainer.style.display = 'none';
            }
        }
        
        function toggleEditModePreCroupier(isEditMode) {
            isEditingPreCroupier = isEditMode;
            
            if (isEditMode) {
                croupierDetailsNameDisplay.style.display = 'none';
                croupierDetailsNameEdit.style.display = 'block';
                croupierJuegosDisplay.style.display = 'none';
                editCroupierJuegosSelector.style.display = 'block';
                btnEditarCroupier.style.display = 'none';
                btnEliminarCroupierPre.style.display = 'none';
                btnGuardarEdicion.style.display = 'block';
                btnCancelarEdicion.style.display = 'block';
                
                renderizarJuegosDropdownEdit(croupiersEnEspera.find(c => c.nombreCompleto === croupierSeleccionadoPre)?.juegosQuePaga || []);
                
            } else {
                croupierDetailsNameDisplay.style.display = 'block';
                croupierDetailsNameEdit.style.display = 'none';
                croupierJuegosDisplay.style.display = 'block';
                editCroupierJuegosSelector.style.display = 'none';
                btnEditarCroupier.style.display = 'block';
                btnEliminarCroupierPre.style.display = 'block';
                btnGuardarEdicion.style.display = 'none';
                btnCancelarEdicion.style.display = 'none';
            }
        }

        function renderizarMesasList() {
            mesasListDiv.innerHTML = '';
            mesasDeJuego.forEach(mesa => {
                const mesaTag = document.createElement('div');
                mesaTag.className = 'mesa-tag';
                mesaTag.textContent = mesa;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-mesa';
                deleteBtn.textContent = 'x';
                deleteBtn.addEventListener('click', () => borrarMesa(mesa));
                mesaTag.appendChild(deleteBtn);
                mesasListDiv.appendChild(mesaTag);
            });
        }
        
        function renderizarJuegosDropdown(dropdownId = 'dropdown-juegos', selectedJuegos = []) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;

            dropdown.innerHTML = '';
            juegosMaestro.forEach(juego => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = juego;
                if (selectedJuegos.includes(juego)) {
                    checkbox.checked = true;
                }
                label.appendChild(checkbox);
                label.innerHTML += juego;
                dropdown.appendChild(label);
            });
        }

        function renderizarJuegosDropdownAdd() {
            renderizarJuegosDropdown('dropdown-juegos', []);
        }

        function renderizarJuegosDropdownEdit(selectedJuegos = []) {
            renderizarJuegosDropdown('dropdown-juegos-edit', selectedJuegos);
        }

        function crearTarjetaRelevo(relevoData) {
            const relevoDiv = document.createElement('div');
            relevoDiv.className = 'relevo-cell';

            if (relevoData.actividad === 'releva') {
                relevoDiv.style.backgroundColor = relevoData.color;
                relevoDiv.textContent = relevoData.mesas.join(' - ');
            } else if (relevoData.actividad === 'ayudante-pagador') {
                relevoDiv.classList.add('ayudante-pagador');
                relevoDiv.textContent = 'AYUD. PAGADOR';
            }
            else {
                let color = '';
                if (relevoData.actividad === 'descanso') {
                    color = '#f39c12';
                } else if (relevoData.actividad === 'sin-actividad') {
                    color = '#95a5a6';
                }
                relevoDiv.style.backgroundColor = color;
                relevoDiv.textContent = relevoData.actividad.toUpperCase();
            }

            return relevoDiv;
        }

        function actualizarReloj() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            relojDigital.textContent = `${hours}:${minutes}:${seconds}`;
        }

        function startAutomaticTimers() {
            const now = new Date();
            const currentHourMinute = now.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit', hour12: false });
            const croupiers = croupiersData.map(c => c.nombreCompleto);
            const horariosMap = {};
            horarios.forEach(h => horariosMap[h] = h);

            croupiers.forEach(croupier => {
                const isCronoRunning = !!cronometroIntervals[croupier];
                const croupierActivities = datosRelevos[croupier] || {};
                const currentActivity = croupierActivities[currentHourMinute];
                const salidaCard = document.querySelector(`[data-croupier-salida="${croupier}"]`);
                const salidaTime = croupierSalidas[croupier];

                if (salidaCard) {
                    const existingWarningIcon = salidaCard.querySelector('.warning-icon');
                    if (salidaTime) {
                        const [salidaHour, salidaMinute] = salidaTime.split(':').map(Number);
                        const salidaDate = new Date();
                        salidaDate.setHours(salidaHour, salidaMinute, 0);

                        const diffInMinutes = (salidaDate.getTime() - now.getTime()) / (1000 * 60);

                        if (diffInMinutes > 0 && diffInMinutes <= 20) {
                            salidaCard.classList.add('warning');
                            if (!existingWarningIcon) {
                                const warningSpan = document.createElement('span');
                                warningSpan.className = 'warning-icon';
                                warningSpan.textContent = '⚠️';
                                salidaCard.appendChild(warningSpan);
                            }
                            const displayCard = document.querySelector(`[data-croupier-crono="${croupier}"] .cronometro-display`);
                            if (displayCard) {
                                displayCard.classList.remove('running');
                                displayCard.classList.add('warning');
                            }
                        } else {
                            salidaCard.classList.remove('warning');
                            if (existingWarningIcon) {
                                existingWarningIcon.remove();
                            }
                            const displayCard = document.querySelector(`[data-croupier-crono="${croupier}"] .cronometro-display`);
                            if (displayCard && displayCard.classList.contains('warning')) {
                                displayCard.classList.remove('warning');
                            }
                        }
                    } else {
                        salidaCard.classList.remove('warning');
                        if (existingWarningIcon) {
                            existingWarningIcon.remove();
                        }
                    }
                }
                
                if (currentActivity && currentActivity.actividad === 'releva' && !isCronoRunning) {
                    const [hours, minutes] = currentHourMinute.split(':').map(Number);
                    const cronoStart = new Date();
                    cronoStart.setHours(hours, minutes, 0, 0);
                    startCronometro(croupier, cronoStart.getTime());
                    return;
                }

                if (currentActivity && (currentActivity.actividad === 'descanso' || currentActivity.actividad === 'ayudante-pagador') && isCronoRunning) {
                    stopCronometro(croupier, true);
                    return;
                }
            });
        }

        function startCronometro(croupier, startTime = new Date().getTime()) {
            if (cronometroIntervals[croupier]) {
                clearInterval(cronometroIntervals[croupier]);
            }
            cronometroStartTime[croupier] = startTime;

            const displayElements = document.querySelectorAll(`[data-croupier-crono="${croupier}"] .timer`);
            const displayCard = document.querySelector(`[data-croupier-crono="${croupier}"] .cronometro-display`);

            if (displayCard) {
                displayCard.classList.add('running');
                displayCard.classList.remove('warning');
            }

            cronometroIntervals[croupier] = setInterval(() => {
                const now = new Date().getTime();
                const elapsed = now - cronometroStartTime[croupier];
                const formattedTime = formatElapsedTime(elapsed);
                displayElements.forEach(display => display.textContent = formattedTime);
                if (croupierCronoActivo === croupier) {
                    cronoModalTimer.textContent = formattedTime;
                    document.getElementById('crono-modal-content').querySelector('.timer-container').classList.add('running');
                }
            }, 1000);

            guardarDatos();
        }

        function updateCronoDisplay(croupier, timeString) {
            const displayElements = document.querySelectorAll(`[data-croupier-crono="${croupier}"] .timer`);
            displayElements.forEach(display => display.textContent = timeString);
            if (croupierCronoActivo === croupier) {
                cronoModalTimer.textContent = timeString;
            }
        }

        function stopCronometro(croupier, resetState = false) {
            if (cronometroIntervals[croupier]) {
                clearInterval(cronometroIntervals[croupier]);
                delete cronometroIntervals[croupier];

                const displayCard = document.querySelector(`[data-croupier-crono="${croupier}"] .cronometro-display`);
                if (displayCard) displayCard.classList.remove('running');

                if (croupierCronoActivo === croupier) {
                    document.getElementById('crono-modal-content').querySelector('.timer-container').classList.remove('running');
                }
            }

            if (resetState) {
                delete cronometroStartTime[croupier];
                updateCronoDisplay(croupier, '00:00:00');
            }
            guardarDatos();
        }

        function resetCronometro(croupier) {
            stopCronometro(croupier, true);
        }

        function formatElapsedTime(elapsed) {
            const totalSeconds = Math.floor(elapsed / 1000);
            const hours = Math.floor((totalSeconds % 86400) / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const formatTime = (time) => time.toString().padStart(2, '0');
            return `${formatTime(hours)}:${formatTime(minutes)}:${formatTime(seconds)}`;
        }


        function editarHorario(oldTime) {
            const th = document.querySelector(`th[data-horario="${oldTime}"]`);
            if (!th) return;
            const contentDiv = th.querySelector('.horario-header-content');
            if (!contentDiv) return;

            const editSpan = contentDiv.querySelector('.edit-time');
            if (editSpan.querySelector('input')) return;

            const originalContent = contentDiv.innerHTML;
            contentDiv.innerHTML = '';
            contentDiv.classList.add('editing');

            const input = document.createElement('input');
            input.type = 'time';
            input.value = oldTime;
            contentDiv.appendChild(input);
            input.focus();

            const guardarCambio = () => {
                const newTime = input.value;
                if (newTime && newTime !== oldTime && !horarios.includes(newTime)) {
                    const croupiers = croupiersData.map(c => c.nombreCompleto);
                    croupiers.forEach(croupier => {
                        if (datosRelevos[croupier] && datosRelevos[croupier][oldTime]) {
                            const relevoData = datosRelevos[croupier][oldTime];
                            delete datosRelevos[croupier][oldTime];
                            datosRelevos[croupier][newTime] = relevoData;
                        }
                    });

                    if (horarioColors[oldTime]) {
                        horarioColors[newTime] = horarioColors[oldTime];
                        delete horarioColors[oldTime];
                    }

                    const oldIndex = horarios.indexOf(oldTime);
                    horarios.splice(oldIndex, 1, newTime);
                    
                    renderizarHorario(true, newTime);
                } else {
                    renderizarHorario();
                }
            };

            input.addEventListener('blur', guardarCambio);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    guardarCambio();
                }
            });
        }

        function borrarHorario(hora) {
            if (confirm(`¿Estás seguro de que quieres eliminar el horario ${hora}? Se borrarán todos los relevos en esta columna.`)) {
                const index = horarios.indexOf(hora);
                if (index > -1) {
                    horarios.splice(index, 1);
                }

                const croupiers = croupiersData.map(c => c.nombreCompleto);
                croupiers.forEach(croupier => {
                    if (datosRelevos[croupier]) {
                        delete datosRelevos[croupier][hora];
                    }
                });

                if (horarioColors[hora]) {
                    delete horarioColors[hora];
                }

                renderizarHorario();
                startAutomaticTimers();
            }
        }

        function borrarCroupier(croupierABorrar) {
            if (confirm(`¿Estás seguro de que quieres eliminar a ${croupierABorrar} de la tabla de horarios? Se mantendrá en la base de datos de croupiers.`)) {
                const croupierIndex = croupiersData.findIndex(c => c.nombreCompleto === croupierABorrar);
                if (croupierIndex > -1) {
                    croupiersData.splice(croupierIndex, 1);
                    delete datosRelevos[croupierABorrar];
                    delete croupierColors[croupierABorrar];
                    delete croupierSalidas[croupierABorrar];
                    stopCronometro(croupierABorrar, true);
                    renderizarHorario();
                }
            }
        }

        function borrarMesa(mesaABorrar) {
            if (confirm(`¿Estás seguro de que quieres eliminar la mesa "${mesaABorrar}"?`)) {
                const index = mesasDeJuego.indexOf(mesaABorrar);
                if (index > -1) {
                    mesasDeJuego.splice(index, 1);

                    for (const croupier in datosRelevos) {
                        for (const horario in datosRelevos[croupier]) {
                            const relevo = datosRelevos[croupier][horario];
                            if (relevo.actividad === 'releva') {
                                relevo.mesas = relevo.mesas.filter(m => m !== mesaABorrar);
                                if (relevo.mesas.length === 0) {
                                    delete datosRelevos[croupier][horario];
                                }
                            }
                        }
                    }

                    renderizarHorario();
                }
            }
        }

        function borrarTodosLosDatos() {
            if (confirm('¿Estás seguro de que quieres borrar a TODOS los croupiers, sus horarios, mesas y juegos? Esta acción es irreversible.')) {
                croupiersData = [];
                horarios = [];
                mesasDeJuego = [];
                juegosMaestro = [];
                datosRelevos = {};
                croupierColors = {};
                croupierSalidas = {};
                horarioColors = {};
                historial = [];
                historialIndex = -1;
                croupiersEnEspera = [];
                localStorage.clear();
                stopAllTimers(true);
                renderizarHorario();
                actualizarBotonesDeshacerRehacer();
                alert('Todos los datos del sistema han sido borrados.');
            }
        }
        
        function borrarSoloHorarios() {
            if (confirm('¿Estás seguro de que quieres borrar SOLAMENTE la tabla de horarios? La lista de croupiers y mesas se mantendrá.')) {
                horarios = [];
                datosRelevos = {};
                horarioColors = {};
                historial = [];
                historialIndex = -1;
                stopAllTimers(true);
                renderizarHorario();
                actualizarBotonesDeshacerRehacer();
                alert('La tabla de horarios ha sido borrada.');
            }
        }
        
        function borrarCroupierPre() {
            if (!croupierSeleccionadoPre) return;

            if(confirm(`¿Estás seguro de que quieres eliminar a ${croupierSeleccionadoPre} de la base de datos de croupiers? Esta acción es permanente.`)){
                croupiersEnEspera = croupiersEnEspera.filter(c => c.nombreCompleto !== croupierSeleccionadoPre);

                const croupierEnTablaIndex = croupiersData.findIndex(c => c.nombreCompleto === croupierSeleccionadoPre);
                if(croupierEnTablaIndex !== -1){
                    borrarCroupier(croupierSeleccionadoPre);
                }

                croupierSeleccionadoPre = null;
                renderizarCroupiersPreTable();
                croupierDetailsContainer.style.display = 'none';
                guardarDatos();
            }
        }

        function aplicarColorACroupiers() {
            const color = colorPicker.value;
            const checkboxes = document.querySelectorAll('.croupier-checkbox:checked');

            if (checkboxes.length === 0) {
                alert('Selecciona al menos un croupier para aplicar el color.');
                return;
            }

            checkboxes.forEach(checkbox => {
                croupierColors[checkbox.value] = color;
            });

            renderizarHorario();
        }

        function generarAlias(nombreCompleto) {
            const partes = nombreCompleto.split(' ').filter(p => p.length > 0);
            if (partes.length < 2) {
                return nombreCompleto.substring(0, 10);
            }
            const nombre = partes[0];
            const inicialApellido = partes[1][0];
            return `${nombre} ${inicialApellido}.`;
        }

        function agregarCroupierDB() {
            const nombreCompleto = nuevoCroupierInput.value.trim();
            if (!nombreCompleto) {
                alert('El nombre y apellido son obligatorios.');
                return;
            }

            if (croupiersEnEspera.some(c => c.nombreCompleto === nombreCompleto)) {
                alert('Este croupier ya existe en la base de datos.');
                return;
            }

            const juegosSeleccionados = Array.from(dropdownJuegos.querySelectorAll('input:checked')).map(cb => cb.value);

            const nuevoCroupier = {
                nombreCompleto: nombreCompleto,
                juegosQuePaga: juegosSeleccionados
            };

            croupiersEnEspera.push(nuevoCroupier);
            renderizarCroupiersPreTable();
            guardarDatos();
            nuevoCroupierInput.value = '';
            dropdownJuegos.querySelectorAll('input:checked').forEach(cb => cb.checked = false);
        }
        
        function agregarJuegoMaestro() {
            const nombreJuego = nuevoJuegoInput.value.trim();
            if (nombreJuego && !juegosMaestro.includes(nombreJuego)) {
                juegosMaestro.push(nombreJuego);
                renderizarJuegosDropdownAdd();
                guardarDatos();
                nuevoJuegoInput.value = '';
            }
        }
        
        function agregarCroupiersSeleccionados() {
            const croupierCheckboxes = document.querySelectorAll('#croupier-pre-table .pre-croupier-checkbox:checked');

            if (croupierCheckboxes.length === 0) {
                alert('Selecciona al menos un croupier de la lista.');
                return;
            }

            croupierCheckboxes.forEach(checkbox => {
                const nombreCompleto = checkbox.value;
                const croupierDataFromDb = croupiersEnEspera.find(c => c.nombreCompleto === nombreCompleto);

                if (croupierDataFromDb && !croupiersData.some(c => c.nombreCompleto === nombreCompleto)) {
                    const nuevoCroupier = {
                        nombreCompleto: croupierDataFromDb.nombreCompleto,
                        alias: generarAlias(croupierDataFromDb.nombreCompleto),
                        juegosQuePaga: croupierDataFromDb.juegosQuePaga
                    };
                    croupiersData.push(nuevoCroupier);
                    
                    if (!datosRelevos[nombreCompleto]) {
                        datosRelevos[nombreCompleto] = {};
                    }
                    croupierColors[nombreCompleto] = '';
                    croupierSalidas[nombreCompleto] = '';
                }
            });
            renderizarHorario();
        }

        function agregarMesa() {
            const nuevaMesa = nuevaMesaInput.value.trim();
            if (nuevaMesa && !mesasDeJuego.includes(nuevaMesa)) {
                mesasDeJuego.push(nuevaMesa);
                renderizarHorario();
                nuevaMesaInput.value = '';
            }
        }

        function toggleRelevoControls(actividad) {
            if (actividad === 'releva') {
                relevoControlsContainer.style.display = 'block';
            } else {
                relevoControlsContainer.style.display = 'none';
            }
        }

        function abrirRelevoModal(croupier, horario) {
            celdaActiva = { croupier, horario };

            const croupierObj = croupiersData.find(c => c.nombreCompleto === croupier);
            modalTitle.textContent = `Asignar actividad para ${croupierObj.alias}`;
            croupierInfo.textContent = croupierObj.alias;
            horarioInfo.textContent = horario;

            llenarSelectoresModal();

            const relevoExistente = datosRelevos[croupier] ? datosRelevos[croupier][horario] : null;

            mesasDisponiblesDiv.innerHTML = '';
            mesasSeleccionadasDiv.innerHTML = '';
            
            let actividadExistente = relevoExistente ? relevoExistente.actividad : 'releva';
            document.querySelector(`input[name="actividad"][value="${actividadExistente}"]`).checked = true;
            toggleRelevoControls(actividadExistente);

            const mesasRelevo = relevoExistente && relevoExistente.actividad === 'releva' ? relevoExistente.mesas : [];

            mesasDeJuego.forEach(mesa => {
                if (!mesasRelevo.includes(mesa)) {
                    const mesaItem = document.createElement('div');
                    mesaItem.className = 'mesa-item';
                    mesaItem.dataset.mesa = mesa;
                    mesaItem.textContent = mesa;
                    mesasDisponiblesDiv.appendChild(mesaItem);
                }
            });

            mesasRelevo.forEach(mesa => {
                const mesaItem = document.createElement('div');
                mesaItem.className = 'mesa-item';
                mesaItem.dataset.mesa = mesa;
                mesaItem.textContent = mesa;
                mesasSeleccionadasDiv.appendChild(mesaItem);
            });
            
            sugerirCroupierDescanso();

            // Evento para arrastrar y soltar las mesas
            mesasDisponiblesDiv.addEventListener('click', (e) => {
                if (e.target.classList.contains('mesa-item')) {
                    mesasSeleccionadasDiv.appendChild(e.target);
                    e.target.style.backgroundColor = '#3498db';
                    e.target.style.color = 'white';
                    e.target.style.cursor = 'move';
                    sugerirCroupierDescanso();
                }
            });

            mesasSeleccionadasDiv.addEventListener('click', (e) => {
                if (e.target.classList.contains('mesa-item')) {
                    mesasDisponiblesDiv.appendChild(e.target);
                    e.target.style.backgroundColor = '#ecf0f1';
                    e.target.style.color = '#34495e';
                    e.target.style.cursor = 'pointer';
                    sugerirCroupierDescanso();
                }
            });

            new Sortable(mesasSeleccionadasDiv, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: sugerirCroupierDescanso
            });

            Array.from(selectCroupierDescanso.options).forEach(opt => opt.selected = false);
            colorRelevoInput.value = '#3498db';
            aplicarDescansoAutoCheckbox.checked = true;

            if (relevoExistente) {
                if (relevoExistente.actividad === 'releva') {
                    colorRelevoInput.value = relevoExistente.color;
                }
            }

            relevoModal.style.display = 'flex';
        }

        // FUNCIÓN MEJORADA: Ahora llena el selector de descanso y muestra las mesas asignadas
        function llenarSelectoresModal() {
            selectCroupierDescanso.innerHTML = '';
            
            const optDescansoPlaceholder = document.createElement('option');
            optDescansoPlaceholder.value = "";
            optDescansoPlaceholder.textContent = "(Ninguno)";
            selectCroupierDescanso.appendChild(optDescansoPlaceholder);

            croupiersData.forEach(croupierObj => {
                // Obtener el relevo del croupier para el horario activo
                const relevoData = datosRelevos[croupierObj.nombreCompleto] ? datosRelevos[croupierObj.nombreCompleto][celdaActiva.horario] : null;
                let displayAlias = croupierObj.alias;

                // Añadir información de la mesa si está en un relevo
                if (relevoData && relevoData.actividad === 'releva') {
                    const mesas = relevoData.mesas.join(', ');
                    displayAlias += ` (Mesa: ${mesas})`;
                } else if (relevoData && (relevoData.actividad === 'descanso' || relevoData.actividad === 'ayudante-pagador')) {
                    displayAlias += ` (${relevoData.actividad.toUpperCase()})`;
                }
                
                const optionDescanso = document.createElement('option');
                optionDescanso.value = croupierObj.nombreCompleto;
                optionDescanso.textContent = displayAlias;
                selectCroupierDescanso.appendChild(optionDescanso);
            });
        }


        // NUEVA FUNCIÓN PARA SUGERIR CROUPIER PARA DESCANSO
        function sugerirCroupierDescanso() {
            const mesasEnRelevo = Array.from(mesasSeleccionadasDiv.children).map(item => item.dataset.mesa);
            const selectCroupier = document.getElementById('select-croupier-descanso');

            // Limpiar la selección actual
            Array.from(selectCroupier.options).forEach(opt => opt.selected = false);

            if (mesasEnRelevo.length > 0) {
                let mesaToCheck = null;
                // Si hay más de una mesa, usamos la segunda, si no, la única
                if (mesasEnRelevo.length === 1) {
                    mesaToCheck = mesasEnRelevo[0];
                } else if (mesasEnRelevo.length >= 2) {
                    mesaToCheck = mesasEnRelevo[1];
                }
                
                const { croupier, horario } = celdaActiva;
                
                let croupierEncontrado = null;
                
                if (mesaToCheck) {
                    croupiersData.forEach(c => {
                        // No buscar en el propio croupier que estamos asignando
                        if (c.nombreCompleto !== croupier) {
                            const relevo = datosRelevos[c.nombreCompleto] && datosRelevos[c.nombreCompleto][horario];
                            if (relevo && relevo.actividad === 'releva' && relevo.mesas.includes(mesaToCheck)) {
                                croupierEncontrado = c.nombreCompleto;
                            }
                        }
                    });
                }

                if (croupierEncontrado) {
                    const option = selectCroupier.querySelector(`option[value="${croupierEncontrado}"]`);
                    if (option) {
                        option.selected = true;
                    }
                }
            }
        }
        
        function abrirSalidaModal(croupier) {
            croupierSalidaActivo = croupier;
            const croupierObj = croupiersData.find(c => c.nombreCompleto === croupier);
            salidaModalTitle.querySelector('span').textContent = croupierObj.alias;
            const horaSalida = croupierSalidas[croupier] || '';
            salidaTimeDisplay.textContent = horaSalida || '--:--';
            inputSalidaTime.value = horaSalida;
            salidaModal.style.display = 'flex';
        }

        function guardarSalida() {
            if (croupierSalidaActivo) {
                const nuevaHora = inputSalidaTime.value;
                croupierSalidas[croupierSalidaActivo] = nuevaHora;
                renderizarHorario();
                cerrarSalidaModal();
            }
        }

        function borrarSalida() {
            if (croupierSalidaActivo) {
                croupierSalidas[croupierSalidaActivo] = '';
                renderizarHorario();
                cerrarSalidaModal();
            }
        }

        function cerrarSalidaModal() {
            salidaModal.style.display = 'none';
            croupierSalidaActivo = null;
        }

        function openCronoModal(croupier) {
            croupierCronoActivo = croupier;
            const croupierObj = croupiersData.find(c => c.nombreCompleto === croupier);
            cronoModalTitle.querySelector('span').textContent = croupierObj.alias;
            const isRunning = !!cronometroIntervals[croupier];

            cronoBtnStart.disabled = isRunning;
            cronoBtnStop.disabled = !isRunning;

            const display = document.querySelector(`[data-croupier-crono="${croupier}"] .timer`);
            cronoModalTimer.textContent = display.textContent;

            const timerContainer = document.getElementById('crono-modal-content').querySelector('.timer-container');
            if (isRunning) {
                timerContainer.classList.add('running');
            } else {
                timerContainer.classList.remove('running');
            }

            cronoModal.style.display = 'flex';
        }

        function closeCronoModal() {
            cronoModal.style.display = 'none';
            croupierCronoActivo = null;
        }

        function cerrarRelevoModal() {
            relevoModal.style.display = 'none';
        }

        function abrirAgregarHorarioModal() {
            if (horarios.length > 0) {
                const ultimaHora = horarios[horarios.length - 1];
                const [horas, minutos] = ultimaHora.split(':').map(Number);
                const nuevaHoraObj = new Date();
                nuevaHoraObj.setHours(horas, minutos);
                nuevaHoraObj.setMinutes(nuevaHoraObj.getMinutes() + 15);
                inputNuevoHorario.value = nuevaHoraObj.toTimeString().slice(0, 5);
            } else {
                inputNuevoHorario.value = '09:00';
            }

            agregarHorarioModal.style.display = 'flex';
        }

        function cerrarAgregarHorarioModal() {
            agregarHorarioModal.style.display = 'none';
        }

        function guardarNuevoHorario() {
            const nuevaHora = inputNuevoHorario.value;
            agregarHorario(nuevaHora);
            cerrarAgregarHorarioModal();
        }

        function agregarHorario(nuevaHora) {
            if (nuevaHora && !horarios.includes(nuevaHora)) {
                horarios.push(nuevaHora);
                renderizarHorario(true, nuevaHora);
            }
        }

        function guardarRelevo() {
            const { croupier, horario } = celdaActiva;
            const actividadSeleccionada = document.querySelector('input[name="actividad"]:checked').value;
            const croupiersDescansoManual = Array.from(selectCroupierDescanso.selectedOptions).map(option => option.value).filter(val => val !== "");
            const aplicarDescansoAutomatico = aplicarDescansoAutoCheckbox.checked;

            if (!datosRelevos[croupier]) datosRelevos[croupier] = {};

            delete datosRelevos[croupier][horario];

            if (actividadSeleccionada === 'releva') {
                const mesasReleva = Array.from(mesasSeleccionadasDiv.children).map(item => item.dataset.mesa);
                const colorSeleccionado = colorRelevoInput.value;

                if (aplicarDescansoAutomatico) {
                    const croupiersRelevados = new Set();
                    croupiersData.forEach(c => {
                        const relevoAnterior = datosRelevos[c.nombreCompleto] && datosRelevos[c.nombreCompleto][horario];
                        if (relevoAnterior && relevoAnterior.actividad === 'releva') {
                            const mesasComunes = relevoAnterior.mesas.filter(mesa => mesasReleva.includes(mesa));
                            if (mesasComunes.length > 0) {
                                croupiersRelevados.add(c.nombreCompleto);
                            }
                        }
                    });

                    croupiersRelevados.forEach(c => {
                        if (!datosRelevos[c]) datosRelevos[c] = {};
                        datosRelevos[c][horario] = {
                            actividad: 'descanso',
                            mesas: [],
                            color: '#f39c12'
                        };
                        stopCronometro(c, true);
                    });
                }

                if (mesasReleva.length > 0) {
                     datosRelevos[croupier][horario] = {
                        actividad: 'releva',
                        mesas: mesasReleva,
                        color: colorSeleccionado
                    };
                } else {
                    datosRelevos[croupier][horario] = {
                        actividad: 'sin-actividad',
                        mesas: [],
                        color: '#95a5a6'
                    };
                }
            } else if (actividadSeleccionada === 'ayudante-pagador') {
                 datosRelevos[croupier][horario] = {
                    actividad: 'ayudante-pagador',
                    mesas: [],
                    color: '#8e44ad'
                };
            } else if (actividadSeleccionada === 'descanso') {
                datosRelevos[croupier][horario] = {
                    actividad: 'descanso',
                    mesas: [],
                    color: '#f39c12'
                };
            }

            croupiersDescansoManual.forEach(c => {
                if (!datosRelevos[c]) datosRelevos[c] = {};
                datosRelevos[c][horario] = {
                    actividad: 'descanso',
                    mesas: [],
                    color: '#f39c12'
                };
            });

            if (!datosRelevos[croupier][horario]) {
                datosRelevos[croupier][horario] = {
                    actividad: 'sin-actividad',
                    mesas: [],
                    color: '#95a5a6'
                };
            }

            renderizarHorario();
            cerrarRelevoModal();
            startAutomaticTimers();
        }

        function borrarRelevo() {
            const { croupier, horario } = celdaActiva;
            if (confirm('¿Estás seguro de que quieres borrar este relevo?')) {
                if (datosRelevos[croupier] && datosRelevos[croupier][horario]) {
                    delete datosRelevos[croupier][horario];
                }

                renderizarHorario();
                cerrarRelevoModal();
                startAutomaticTimers();
            }
        }


        function refreshCronometros() {
            stopAllTimers(false);
            cargarCronometroState();
            startSavedTimers();
        }
        
        function guardarEdicionPreCroupier() {
            const oldName = croupierSeleccionadoPre;
            const newName = croupierDetailsNameEdit.value.trim();
            const newJuegos = Array.from(dropdownJuegosEdit.querySelectorAll('input:checked')).map(cb => cb.value);

            if (!newName) {
                alert('El nombre no puede estar vacío.');
                return;
            }

            if (newName !== oldName && croupiersEnEspera.some(c => c.nombreCompleto === newName)) {
                alert('Ya existe un croupier con ese nombre en la base de datos.');
                return;
            }

            const croupierIndexEnEspera = croupiersEnEspera.findIndex(c => c.nombreCompleto === oldName);
            if (croupierIndexEnEspera !== -1) {
                croupiersEnEspera[croupierIndexEnEspera].nombreCompleto = newName;
                croupiersEnEspera[croupierIndexEnEspera].juegosQuePaga = newJuegos;
            }

            const croupierInTableIndex = croupiersData.findIndex(c => c.nombreCompleto === oldName);
            if (croupierInTableIndex !== -1) {
                croupiersData[croupierInTableIndex].nombreCompleto = newName;
                croupiersData[croupierInTableIndex].alias = generarAlias(newName);
                croupiersData[croupierInTableIndex].juegosQuePaga = newJuegos;

                if (oldName !== newName) {
                    if (datosRelevos[oldName]) {
                        datosRelevos[newName] = datosRelevos[oldName];
                        delete datosRelevos[oldName];
                    }
                    if (croupierColors[oldName]) {
                        croupierColors[newName] = croupierColors[oldName];
                        delete croupierColors[oldName];
                    }
                    if (croupierSalidas[oldName]) {
                        croupierSalidas[newName] = croupierSalidas[oldName];
                        delete croupierSalidas[oldName];
                    }
                    if (cronometroStartTime[oldName]) {
                        cronometroStartTime[newName] = cronometroStartTime[oldName];
                        delete cronometroStartTime[oldName];
                    }
                }
            }

            croupierSeleccionadoPre = newName;
            renderizarHorario();
            seleccionarCroupierPre(newName);
        }

        // EVENT LISTENERS
        btnAgregarCroupierDB.addEventListener('click', agregarCroupierDB);
        btnPreAgregarJuego.addEventListener('click', agregarJuegoMaestro);
        btnAgregarCroupierTabla.addEventListener('click', agregarCroupiersSeleccionados);
        selectAllPreCroupiers.addEventListener('change', (e) => {
            document.querySelectorAll('#croupier-pre-table .pre-croupier-checkbox').forEach(cb => cb.checked = e.target.checked);
        });

        btnAgregarMesa.addEventListener('click', agregarMesa);
        btnAplicarColor.addEventListener('click', aplicarColorACroupiers);

        closeBtnRelevo.addEventListener('click', cerrarRelevoModal);
        btnGuardarRelevo.addEventListener('click', guardarRelevo);
        btnBorrarRelevo.addEventListener('click', borrarRelevo);

        btnClearAll.addEventListener('click', borrarTodosLosDatos);
        btnClearHorarioOnly.addEventListener('click', borrarSoloHorarios);
        btnBackup.addEventListener('click', generarBackup);
        fileInputRestore.addEventListener('change', restaurarBackup);
        
        btnUndo.addEventListener('click', deshacer);
        btnRedo.addEventListener('click', rehacer);
        
        btnEditarCroupier.addEventListener('click', () => toggleEditModePreCroupier(true));
        btnGuardarEdicion.addEventListener('click', guardarEdicionPreCroupier);
        btnCancelarEdicion.addEventListener('click', () => {
            if(croupierSeleccionadoPre) {
                seleccionarCroupierPre(croupierSeleccionadoPre);
            } else {
                croupierDetailsContainer.style.display = 'none';
            }
        });
        btnEliminarCroupierPre.addEventListener('click', borrarCroupierPre);

        closeBtnAgregarHorario.addEventListener('click', cerrarAgregarHorarioModal);
        btnGuardarNuevoHorario.addEventListener('click', guardarNuevoHorario);

        closeBtnSalida.addEventListener('click', cerrarSalidaModal);
        btnGuardarSalida.addEventListener('click', guardarSalida);
        btnBorrarSalida.addEventListener('click', borrarSalida);

        cronoBtnStart.addEventListener('click', () => {
            if (croupierCronoActivo) {
                const now = new Date();
                startCronometro(croupierCronoActivo, now.getTime());
                cronoBtnStart.disabled = true;
                cronoBtnStop.disabled = false;
            }
        });

        cronoBtnStop.addEventListener('click', () => {
            if (croupierCronoActivo) {
                stopCronometro(croupierCronoActivo, false);
                cronoBtnStart.disabled = false;
                cronoBtnStop.disabled = true;
            }
        });

        cronoBtnReset.addEventListener('click', () => {
            if (croupierCronoActivo) {
                resetCronometro(croupierCronoActivo);
                cronoBtnStart.disabled = false;
                cronoBtnStop.disabled = true;
            }
        });

        closeBtnCrono.addEventListener('click', closeCronoModal);

        btnRefreshCrono.addEventListener('click', refreshCronometros);

        window.addEventListener('click', (event) => {
            if (event.target === relevoModal) {
                cerrarRelevoModal();
            }
            if (event.target === cronoModal) {
                closeCronoModal();
            }
            if (event.target === agregarHorarioModal) {
                cerrarAgregarHorarioModal();
            }
            if (event.target === salidaModal) {
                cerrarSalidaModal();
            }
             if (!juegosSelectorCroupier.contains(event.target)) {
                juegosSelectorCroupier.classList.remove('active');
            }
            if (!document.getElementById('juegos-selector-edit').contains(event.target)) {
                 document.getElementById('juegos-selector-edit').classList.remove('active');
            }
        });
        
        juegosSelectorCroupier.addEventListener('click', () => {
            juegosSelectorCroupier.classList.toggle('active');
        });
        
        const juegosSelectorEdit = document.getElementById('juegos-selector-edit');
        if (juegosSelectorEdit) {
            juegosSelectorEdit.addEventListener('click', (e) => {
                juegosSelectorEdit.classList.toggle('active');
                e.stopPropagation();
            });
        }
        
        dropdownJuegos.addEventListener('click', (event) => {
            event.stopPropagation();
        });
        dropdownJuegosEdit.addEventListener('click', (event) => {
            event.stopPropagation();
        });

        collapsibleHeader.addEventListener('click', () => {
            controlesContainer.classList.toggle('content-hidden');
            collapsibleHeader.classList.toggle('collapsed');
        });
        
        document.querySelectorAll('.control-panel .panel-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                header.classList.toggle('collapsed');
                content.classList.toggle('panel-hidden');
            });
        });
        
        radioReleva.addEventListener('change', () => toggleRelevoControls('releva'));
        radioAyudante.addEventListener('change', () => toggleRelevoControls('ayudante-pagador'));
        radioDescanso.addEventListener('change', () => toggleRelevoControls('descanso'));

        function inicializarSortableJS() {
            new Sortable(tbody, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                filter: function(evt, target) {
                    const checkbox = target.querySelector('.croupier-checkbox');
                    return !checkbox || !checkbox.checked;
                },
                onEnd: function (evt) {
                    const newOrder = [...tbody.children].map(row => row.dataset.croupier);
                    const orderedCroupiersData = newOrder.map(name => croupiersData.find(c => c.nombreCompleto === name));
                    croupiersData = orderedCroupiersData;
                    renderizarHorario();
                }
            });
        }

        function inicializar() {
            cargarDatos();
            cargarCronometroState();
            renderizarHorario(false);
            actualizarBotonesDeshacerRehacer();
            setInterval(() => {
                actualizarReloj();
                startAutomaticTimers();
            }, 1000);
            actualizarReloj();
            startSavedTimers();
            inicializarSortableJS();
            renderizarJuegosDropdownAdd();
        }

        inicializar();
    </script>

    <footer>
        CarlosPN Interactive®
    </footer>

</body>
</html>
